{
  "name": "WhatsApp Bot Simple - Funcionando",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp-bot",
        "responseMode": "onReceived",
        "options": {}
      },
      "id": "webhook-entrada",
      "name": "Webhook WhatsApp",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "whatsapp-bot"
    },
    {
      "parameters": {
        "jsCode": "// Extraer datos del webhook de EvolutionAPI\nconst data = $input.all()[0].json;\n\nconsole.log('Datos recibidos:', JSON.stringify(data, null, 2));\n\n// Inicializar variables\nlet messageText = '';\nlet userNumber = '';\nlet userName = 'Usuario';\n\n// Extraer informaciÃ³n del mensaje\ntry {\n  // Para EvolutionAPI v2.x\n  if (data.body && data.body.data) {\n    messageText = data.body.data.message?.conversation || \n                  data.body.data.message?.extendedTextMessage?.text || '';\n    userNumber = data.body.data.key?.remoteJid?.replace('@s.whatsapp.net', '') || '';\n    userName = data.body.data.pushName || 'Usuario';\n  }\n  // Fallback para otras estructuras\n  else if (data.data) {\n    messageText = data.data.message?.conversation || \n                  data.data.message?.extendedTextMessage?.text || '';\n    userNumber = data.data.key?.remoteJid?.replace('@s.whatsapp.net', '') || '';\n    userName = data.data.pushName || 'Usuario';\n  }\n  // Si no encuentra estructura, usar valores por defecto\n  else {\n    messageText = 'hola';\n    userNumber = '5493735507036';\n  }\n} catch (error) {\n  console.log('Error procesando datos:', error);\n  messageText = 'hola';\n  userNumber = '5493735507036';\n  userName = 'Usuario';\n}\n\n// Procesar el mensaje\nconst normalizedMessage = messageText.toLowerCase().trim();\n\nlet responseText = '';\n\nif (normalizedMessage.includes('hola') || normalizedMessage.includes('hi') || normalizedMessage === '') {\n  responseText = `ğŸ¤– Â¡Hola ${userName}! ğŸ‘‹\\n\\nSoy Anita, tu asistente mÃ©dica virtual.\\n\\nğŸ“‹ Â¿En quÃ© puedo ayudarte?\\n\\nâ€¢ Escribe \"cita\" para agendar\\nâ€¢ Escribe \"menu\" para ver opciones`;\n} else if (normalizedMessage.includes('cita')) {\n  responseText = `ğŸ“… *GestiÃ³n de Citas*\\n\\nPara agendar una cita, necesito:\\n\\nğŸ‘¤ Tus datos:\\nâ€¢ Nombre completo\\nâ€¢ DNI\\nâ€¢ Obra social\\nâ€¢ TelÃ©fono\\n\\nğŸ“… Fecha preferida\\n\\nPor favor envÃ­a estos datos y te mostrarÃ© los horarios disponibles.`;\n} else if (normalizedMessage.includes('menu')) {\n  responseText = `ğŸ“‹ *MenÃº Principal*\\n\\nğŸ¥ Servicios disponibles:\\n\\nâ€¢ \"cita\" - Agendar nueva cita\\nâ€¢ \"horarios\" - Ver horarios disponibles\\nâ€¢ \"contacto\" - InformaciÃ³n de contacto\\nâ€¢ \"ayuda\" - Ayuda y soporte\\n\\nÂ¿QuÃ© necesitas hoy?`;\n} else if (normalizedMessage.includes('contacto')) {\n  responseText = `ğŸ“ *InformaciÃ³n de Contacto*\\n\\nğŸ¥ ClÃ­nica MÃ©dica\\nğŸ“ DirecciÃ³n: [Tu direcciÃ³n]\\nâ˜ï¸ TelÃ©fono: [Tu telÃ©fono]\\nğŸ•’ Horarios: Lunes a Viernes 8:00-20:00\\n\\nğŸ’» Web: https://micitamedica.me\\nğŸ“± WhatsApp: Este nÃºmero`;\n} else if (normalizedMessage.includes('horarios')) {\n  responseText = `ğŸ•’ *Horarios Disponibles*\\n\\nğŸ“… Lunes a Viernes:\\nâ€¢ MaÃ±ana: 8:00 - 12:00\\nâ€¢ Tarde: 14:00 - 20:00\\n\\nğŸ“… SÃ¡bados:\\nâ€¢ MaÃ±ana: 8:00 - 12:00\\n\\nâŒ Domingos: Cerrado\\n\\nPara agendar escribe \"cita\"`;\n} else {\n  responseText = `ğŸ¤” No entendÃ­ tu mensaje: \"${messageText}\"\\n\\nğŸ“‹ Prueba escribir:\\nâ€¢ \"hola\" para saludar\\nâ€¢ \"menu\" para ver opciones\\nâ€¢ \"cita\" para agendar\\n\\nÂ¿En quÃ© puedo ayudarte?`;\n}\n\n// Retornar datos para enviar\nreturn {\n  json: {\n    number: userNumber,\n    text: responseText,\n    originalMessage: messageText,\n    userName: userName\n  }\n};"
      },
      "id": "procesar-mensaje",
      "name": "Procesar Mensaje",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://69.62.89.195:8080/message/sendText/test-9",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "apikey",
              "value": "6ED32D1B9D3F-4EC9-B3FA-1BC82E369E34"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "jsonBody": "={\n  \"number\": \"{{ $json.number }}\",\n  \"text\": \"{{ $json.text }}\"\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "enviar-whatsapp",
      "name": "Enviar a WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [680, 300]
    }
  ],
  "connections": {
    "Webhook WhatsApp": {
      "main": [
        [
          {
            "node": "Procesar Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Mensaje": {
      "main": [
        [
          {
            "node": "Enviar a WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-11-12T00:00:00.000Z",
  "versionId": "1"
}