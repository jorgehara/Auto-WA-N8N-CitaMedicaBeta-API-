{
  "name": "WhatsApp Simple Bot - CitaMedica",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp-simple",
        "responseMode": "onReceived",
        "options": {}
      },
      "id": "webhook-whatsapp",
      "name": "Webhook - WhatsApp",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        240,
        300
      ],
      "webhookId": "whatsapp-simple"
    },
    {
      "parameters": {
        "url": "http://69.62.89.195:8080/message/sendText/test-9",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "jsonBody": "{\n  \"number\": \"{{ $json.data.key.remoteJid.replace('@s.whatsapp.net', '') }}\",\n  \"text\": \"ğŸ¤– Â¡Hola! Soy Anita, tu asistente mÃ©dica.\\n\\nğŸ“‹ Puedo ayudarte con:\\nâ€¢ Agendar citas mÃ©dicas\\nâ€¢ Consultar horarios disponibles\\nâ€¢ Gestionar sobreturnos\\n\\nâœï¸ Escribe 'menu' para ver todas las opciones disponibles.\"\n}",
        "options": {}
      },
      "id": "http-send-response",
      "name": "Enviar Respuesta WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        680,
        300
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "evolution-api-key",
          "name": "Evolution API Key"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "message-exists",
              "leftValue": "={{ $json.data.message }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "exists",
                "rightType": "any"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "filter-messages",
      "name": "Filtrar solo mensajes",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        460,
        300
      ]
    },
    {
      "parameters": {
        "url": "https://micitamedica.me/api/appointments/available",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {}
      },
      "id": "get-available-appointments",
      "name": "Consultar Citas Disponibles",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        460,
        500
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "multiplex",
        "options": {}
      },
      "id": "merge-data",
      "name": "Combinar Datos",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        680,
        500
      ]
    },
    {
      "parameters": {
        "jsCode": "// Procesar mensaje y generar respuesta inteligente\nconst webhookData = $input.first();\nconst appointmentData = $input.last();\n\n// Extraer informaciÃ³n del mensaje\nconst messageText = webhookData.json.data.message?.conversation || \n                   webhookData.json.data.message?.extendedTextMessage?.text || '';\nconst userNumber = webhookData.json.data.key.remoteJid.replace('@s.whatsapp.net', '');\nconst userName = webhookData.json.data.pushName || 'Usuario';\n\n// Normalizar mensaje\nconst normalizedMessage = messageText.toLowerCase().trim();\n\nlet responseText = '';\n\n// LÃ³gica conversacional\nif (normalizedMessage.includes('hola') || normalizedMessage.includes('hi') || normalizedMessage === '') {\n  responseText = `Â¡Hola ${userName}! ğŸ‘‹\\n\\nSoy Anita, tu asistente virtual para citas mÃ©dicas.\\n\\nğŸ“‹ Â¿En quÃ© puedo ayudarte hoy?\\n\\nâ€¢ Escriba \"cita\" para agendar una cita\\nâ€¢ Escriba \"menu\" para ver todas las opciones`;\n} else if (normalizedMessage.includes('cita') || normalizedMessage.includes('turno')) {\n  // Mostrar citas disponibles si hay datos\n  if (appointmentData && appointmentData.json && appointmentData.json.length > 0) {\n    const availableSlots = appointmentData.json.slice(0, 5); // Primeras 5 citas\n    responseText = `ğŸ“… *Citas Disponibles:*\\n\\n`;\n    \n    availableSlots.forEach((slot, index) => {\n      const date = new Date(slot.date).toLocaleDateString('es-AR');\n      const time = slot.time;\n      responseText += `${index + 1}. ${date} a las ${time}\\n`;\n    });\n    \n    responseText += `\\nâœï¸ Para agendar, responda con el nÃºmero de la cita que prefiere.`;\n  } else {\n    responseText = `ğŸ“… Consultando disponibilidad...\\n\\nPor favor, proporcione:\\nâ€¢ Su nombre completo\\nâ€¢ Obra social\\nâ€¢ Fecha preferida\\n\\nO escriba \"disponible\" para ver horarios libres.`;\n  }\n} else if (normalizedMessage.includes('menu') || normalizedMessage.includes('ayuda')) {\n  responseText = `ğŸ“‹ *MenÃº de Opciones:*\\n\\nğŸ¥ **Citas MÃ©dicas:**\\nâ€¢ \"cita\" - Agendar nueva cita\\nâ€¢ \"disponible\" - Ver horarios disponibles\\nâ€¢ \"cancelar\" - Cancelar cita existente\\n\\nâš¡ **Sobreturnos:**\\nâ€¢ \"sobreturno\" - Solicitar sobreturno\\nâ€¢ \"urgente\" - AtenciÃ³n urgente\\n\\nğŸ“ **Contacto:**\\nâ€¢ \"contacto\" - InformaciÃ³n de contacto\\nâ€¢ \"ubicacion\" - DirecciÃ³n de la clÃ­nica\\n\\nÂ¿En quÃ© puedo ayudarte?`;\n} else if (normalizedMessage.includes('sobreturno') || normalizedMessage.includes('urgente')) {\n  responseText = `âš¡ *Sobreturnos y Urgencias:*\\n\\nPara solicitar un sobreturno, necesito:\\n\\nğŸ‘¤ Datos del paciente:\\nâ€¢ Nombre completo\\nâ€¢ DNI\\nâ€¢ Obra social\\n\\nğŸ©º Motivo de la consulta:\\nâ€¢ DescripciÃ³n del problema\\nâ€¢ Nivel de urgencia\\n\\nğŸ“± EnvÃ­e esta informaciÃ³n y le confirmarÃ© disponibilidad.`;\n} else if (normalizedMessage.includes('contacto')) {\n  responseText = `ğŸ“ *InformaciÃ³n de Contacto:*\\n\\nğŸ¥ ClÃ­nica MÃ©dica\\nğŸ“ DirecciÃ³n: [DirecciÃ³n de la clÃ­nica]\\nâ˜ï¸ TelÃ©fono: [NÃºmero de telÃ©fono]\\nğŸ•’ Horarios: Lunes a Viernes 8:00 - 20:00\\n\\nğŸ’» TambiÃ©n puede gestionar sus citas a travÃ©s de:\\nğŸŒ https://micitamedica.me`;\n} else if (normalizedMessage.includes('cancelar')) {\n  responseText = `âŒ *Cancelar Cita:*\\n\\nPara cancelar su cita, necesito:\\nâ€¢ Su nombre completo\\nâ€¢ DNI\\nâ€¢ Fecha de la cita a cancelar\\n\\nâš ï¸ Las cancelaciones deben realizarse con al menos 24hs de anticipaciÃ³n.`;\n} else {\n  // Respuesta por defecto para mensajes no reconocidos\n  responseText = `ğŸ¤– No pude entender su mensaje.\\n\\nğŸ“‹ Escriba \"menu\" para ver las opciones disponibles o \"ayuda\" para obtener asistencia.\\n\\nÂ¿En quÃ© puedo ayudarle?`;\n}\n\n// Preparar respuesta\nreturn {\n  json: {\n    number: userNumber,\n    text: responseText,\n    originalMessage: messageText,\n    userName: userName,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "process-message",
      "name": "Procesar Mensaje",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        400
      ]
    },
    {
      "parameters": {
        "url": "http://69.62.89.195:8080/message/sendText/test-9",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "jsonBody": "={\n  \"number\": \"{{ $json.number }}\",\n  \"text\": \"{{ $json.text }}\"\n}",
        "options": {}
      },
      "id": "send-intelligent-response",
      "name": "Enviar Respuesta Inteligente",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1120,
        400
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "evolution-api-key",
          "name": "Evolution API Key"
        }
      }
    }
  ],
  "connections": {
    "Webhook - WhatsApp": {
      "main": [
        [
          {
            "node": "Filtrar solo mensajes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtrar solo mensajes": {
      "main": [
        [
          {
            "node": "Enviar Respuesta WhatsApp",
            "type": "main",
            "index": 0
          },
          {
            "node": "Consultar Citas Disponibles",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Citas Disponibles": {
      "main": [
        [
          {
            "node": "Combinar Datos",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Enviar Respuesta WhatsApp": {
      "main": [
        [
          {
            "node": "Combinar Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combinar Datos": {
      "main": [
        [
          {
            "node": "Procesar Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Mensaje": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Inteligente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-11-11T23:30:00.000Z",
  "versionId": "1"
}