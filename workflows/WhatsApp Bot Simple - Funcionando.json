{
  "nodes": [
    {
      "parameters": {
        "jsCode": "// ===== PROCESADOR PRINCIPAL DE MENSAJES CON ESTADOS =====\nconst data = $input.all()[0].json;\n\nconsole.log('Datos recibidos:', JSON.stringify(data, null, 2));\n\n// Extraer informaci√≥n del mensaje\nlet messageText = '';\nlet userNumber = '';\nlet userName = 'Usuario';\n\ntry {\n  if (data.body && data.body.data) {\n    messageText = data.body.data.message?.conversation ||\n                  data.body.data.message?.extendedTextMessage?.text || '';\n    userNumber = data.body.data.key?.remoteJid?.replace('@s.whatsapp.net', '') || '';\n    userName = data.body.data.pushName || 'Usuario';\n  } else if (data.data) {\n    messageText = data.data.message?.conversation ||\n                  data.data.message?.extendedTextMessage?.text || '';\n    userNumber = data.data.key?.remoteJid?.replace('@s.whatsapp.net', '') || '';\n    userName = data.data.pushName || 'Usuario';\n  } else {\n    messageText = 'hola';\n    userNumber = '5493735507036';\n  }\n} catch (error) {\n  console.log('Error procesando datos:', error);\n  messageText = 'hola';\n  userNumber = '5493735507036';\n  userName = 'Usuario';\n}\n\nconst normalizedMessage = messageText.toLowerCase().trim();\n\n// Estado del usuario viaja en el propio flujo\nlet currentState = data.currentState || 'menu';\nlet stateData = data.stateData || {};\n\nlet responseData = {\n  userNumber,\n  userName,\n  messageText,\n  normalizedMessage,\n  currentState,\n  stateData,\n  action: 'send_message', // default action\n  needsAPICall: false,\n  apiEndpoint: '',\n  apiData: {}\n};\n\n// ===== L√ìGICA DE ESTADOS =====\nswitch (currentState) {\n  case 'menu':\n  case 'initial':\n    if (normalizedMessage.includes('hola') || normalizedMessage.includes('hi') || normalizedMessage === '') {\n      responseData.responseText = `ü§ñ ¬°Hola ${userName}! üëã\\n\\nSoy Anita, tu asistente m√©dica virtual.\\n\\nüìã ¬øEn qu√© puedo ayudarte?\\n\\nüü¢ Escribe *1* para agendar una cita\\nüü¢ Escribe *2* para ver horarios disponibles\\nüü¢ Escribe *3* para informaci√≥n de contacto\\nüü¢ Escribe *menu* para volver aqu√≠`;\n      currentState = 'waiting_menu_option';\n    } else if (normalizedMessage.includes('1') || normalizedMessage.includes('cita') || normalizedMessage.includes('agendar')) {\n      responseData.responseText = `üìÖ *Perfecto! Vamos a agendar tu cita* ‚úÖ\\n\\nPara comenzar, necesito algunos datos:\\n\\nüë§ **Paso 1 de 5: Nombre completo**\\n\\nPor favor escribe tu nombre completo:`;\n      currentState = 'collecting_name';\n      stateData = {};\n    } else if (normalizedMessage.includes('2') || normalizedMessage.includes('horarios')) {\n      responseData.responseText = `üìÖ *Consulta de Horarios Disponibles*\\n\\nPor favor env√≠ame la fecha en formato DD/MM/AAAA\\n\\nEjemplo: 15/12/2024\\n\\nüí° Tip: Solo consulto horarios de lunes a s√°bado`;\n      currentState = 'asking_date_for_availability';\n    } else if (normalizedMessage.includes('3') || normalizedMessage.includes('contacto')) {\n      responseData.responseText = `üìû *Informaci√≥n de Contacto*\\n\\nüè• **Consultorio M√©dico**\\nüìç Direcci√≥n: [Tu direcci√≥n aqu√≠]\\n‚òéÔ∏è Tel√©fono: [Tu tel√©fono]\\nüïí Horarios de Atenci√≥n:\\n\\nüìÖ **Lunes a Viernes:**\\nüåÖ Ma√±ana: 10:00 - 12:00\\nüåÜ Tarde: 17:00 - 20:00\\n\\nüìÖ **S√°bados:**\\nüåÖ Ma√±ana: 10:00 - 12:00\\n\\n‚ùå **Domingos:** Cerrado\\n\\nüíª Web: https://micitamedica.me\\nüì± WhatsApp: Este n√∫mero\\n\\nEscribe *menu* para volver al men√∫ principal`;\n      currentState = 'waiting_menu_option';\n    } else {\n      responseData.responseText = `ü§î No entend√≠ tu mensaje: \"${messageText}\"\\n\\nüìã Opciones disponibles:\\n\\nüü¢ Escribe *1* para agendar una cita\\nüü¢ Escribe *2* para ver horarios\\nüü¢ Escribe *3* para informaci√≥n de contacto\\nüü¢ Escribe *menu* para el men√∫ principal`;\n      currentState = 'waiting_menu_option';\n    }\n    break;\n\n  case 'waiting_menu_option':\n    if (normalizedMessage.includes('1') || normalizedMessage.includes('cita')) {\n      responseData.responseText = `üìÖ *Perfecto! Vamos a agendar tu cita* ‚úÖ\\n\\nPara comenzar, necesito algunos datos:\\n\\nüë§ **Paso 1 de 5: Nombre completo**\\n\\nPor favor escribe tu nombre completo:`;\n      currentState = 'collecting_name';\n      stateData = {};\n    } else if (normalizedMessage.includes('2') || normalizedMessage.includes('horarios')) {\n      responseData.responseText = `üìÖ *Consulta de Horarios Disponibles*\\n\\nPor favor env√≠ame la fecha en formato DD/MM/AAAA\\n\\nEjemplo: 15/12/2024`;\n      currentState = 'asking_date_for_availability';\n    } else if (normalizedMessage.includes('3') || normalizedMessage.includes('contacto')) {\n      responseData.responseText = `üìû *Informaci√≥n de Contacto*\\n\\nüè• **Consultorio M√©dico**\\nüìç Direcci√≥n: [Tu direcci√≥n]\\n‚òéÔ∏è Tel√©fono: [Tu tel√©fono]\\nüïí Horarios: Lunes a Viernes 10:00-12:00, 17:00-20:00\\nS√°bados: 10:00-12:00\\n\\nüíª Web: https://micitamedica.me\\n\\nEscribe *menu* para volver al men√∫ principal`;\n      currentState = 'waiting_menu_option';\n    } else if (normalizedMessage.includes('menu')) {\n      responseData.responseText = `üìã *Men√∫ Principal*\\n\\nüü¢ Escribe *1* para agendar una cita\\nüü¢ Escribe *2* para ver horarios disponibles\\nüü¢ Escribe *3* para informaci√≥n de contacto`;\n      currentState = 'waiting_menu_option';\n    } else {\n      responseData.responseText = `ü§î Opci√≥n no v√°lida.\\n\\nüìã Opciones disponibles:\\n\\nüü¢ *1* - Agendar cita\\nüü¢ *2* - Ver horarios\\nüü¢ *3* - Contacto\\nüü¢ *menu* - Men√∫ principal`;\n    }\n    break;\n\n  case 'asking_date_for_availability':\n    // Validar formato de fecha DD/MM/AAAA\n   const dateMatch = messageText.match(new RegExp('(\\\\d{1,2})\\\\/(\\\\d{1,2})\\\\/(\\\\d{4})'));\n    if (dateMatch) {\n      const [, day, month, year] = dateMatch;\n      const requestedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;\n      responseData.needsAPICall = true;\n      responseData.action = 'get_available_times';\n      responseData.apiEndpoint = `/api/appointments/available/${requestedDate}`;\n      responseData.requestedDate = requestedDate;\n      responseData.displayDate = `${day}/${month}/${year}`;\n      currentState = 'waiting_menu_option';\n    } else {\n      responseData.responseText = `‚ùå Formato de fecha incorrecto.\\n\\nPor favor usa el formato: DD/MM/AAAA\\n\\nEjemplo: 15/12/2024\\n\\nIntenta nuevamente:`;\n    }\n    break;\n\n  case 'collecting_name':\n    if (messageText.trim().length >= 3) {\n      stateData.clientName = messageText.trim();\n      responseData.responseText = `‚úÖ Nombre: ${messageText.trim()}\\n\\nüì± **Paso 2 de 5: Tel√©fono**\\n\\nPor favor escribe tu n√∫mero de tel√©fono\\n(puede ser el mismo desde donde escribes):`;\n      currentState = 'collecting_phone';\n    } else {\n      responseData.responseText = `‚ùå El nombre debe tener al menos 3 caracteres.\\n\\nPor favor escribe tu nombre completo:`;\n    }\n    break;\n\n  case 'collecting_phone':\n    const phonePattern = /^[\\\\d\\\\s\\\\-\\\\+\\\\(\\\\)]{7,}$/;\n    if (phonePattern.test(messageText.trim()) || messageText.trim().length >= 7) {\n      stateData.phone = messageText.trim();\n      responseData.responseText = `‚úÖ Tel√©fono: ${messageText.trim()}\\n\\nüè• **Paso 3 de 5: Obra Social**\\n\\nSelecciona tu obra social:\\n\\n1Ô∏è‚É£ INSSSEP\\n2Ô∏è‚É£ Swiss Medical\\n3Ô∏è‚É£ OSDE\\n4Ô∏è‚É£ Galeno\\n5Ô∏è‚É£ Consulta Particular\\n6Ô∏è‚É£ Otras Obras Sociales\\n\\nEscribe el n√∫mero de tu opci√≥n:`;\n      currentState = 'collecting_social_work';\n    } else {\n      responseData.responseText = `‚ùå Formato de tel√©fono incorrecto.\\n\\nPor favor escribe un n√∫mero de tel√©fono v√°lido:`;\n    }\n    break;\n\n  case 'collecting_social_work':\n    const socialWorkOptions = {\n      '1': 'INSSSEP',\n      '2': 'Swiss Medical',\n      '3': 'OSDE',\n      '4': 'Galeno',\n      '5': 'CONSULTA PARTICULAR',\n      '6': 'Otras Obras Sociales'\n    };\n    if (socialWorkOptions[normalizedMessage]) {\n      stateData.socialWork = socialWorkOptions[normalizedMessage];\n      responseData.responseText = `‚úÖ Obra Social: ${socialWorkOptions[normalizedMessage]}\\n\\nüìß **Paso 4 de 5: Email (opcional)**\\n\\nEscribe tu email o env√≠a \\\"sin email\\\" para continuar:`;\n      currentState = 'collecting_email';\n    } else {\n      responseData.responseText = `‚ùå Opci√≥n no v√°lida.\\n\\nPor favor selecciona un n√∫mero del 1 al 6:\\n\\n1Ô∏è‚É£ INSSSEP\\n2Ô∏è‚É£ Swiss Medical\\n3Ô∏è‚É£ OSDE\\n4Ô∏è‚É£ Galeno\\n5Ô∏è‚É£ Consulta Particular\\n6Ô∏è‚É£ Otras Obras Sociales`;\n    }\n    break;\n\n  case 'collecting_email':\n    if (normalizedMessage.includes('sin email') || normalizedMessage.includes('no')) {\n      stateData.email = '';\n      responseData.responseText = `‚úÖ Email: No proporcionado\\n\\nüìÖ **Paso 5 de 5: Seleccionar fecha**\\n\\nEscribe la fecha deseada en formato DD/MM/AAAA\\n\\nEjemplo: 15/12/2024\\n\\nüí° Atenci√≥n de lunes a s√°bado`;\n      currentState = 'collecting_date';\n    } else {\n      const emailPattern = /^[^\\\\s@]+@[^\\\\s@]+\\\\.[^\\\\s@]+$/;\n      if (emailPattern.test(messageText.trim())) {\n        stateData.email = messageText.trim();\n        responseData.responseText = `‚úÖ Email: ${messageText.trim()}\\n\\nüìÖ **Paso 5 de 5: Seleccionar fecha**\\n\\nEscribe la fecha deseada en formato DD/MM/AAAA\\n\\nEjemplo: 15/12/2024\\n\\nüí° Atenci√≥n de lunes a s√°bado`;\n        currentState = 'collecting_date';\n      } else {\n        responseData.responseText = `‚ùå Email no v√°lido.\\n\\nEjemplo: usuario@email.com\\n\\nO escribe \\\"sin email\\\" para continuar:`;\n      }\n    }\n    break;\n\n  case 'collecting_date':\nconst appointmentDateMatch = messageText.match(new RegExp('(\\\\d{1,2})\\\\/(\\\\d{1,2})\\\\/(\\\\d{4})'));\n    if (appointmentDateMatch) {\n      const [, day, month, year] = appointmentDateMatch;\n      const appointmentDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;\n      // Validar que la fecha no sea en el pasado\n      const today = new Date();\n      const selectedDate = new Date(appointmentDate);\n      if (selectedDate < today) {\n        responseData.responseText = `‚ùå No puedes agendar citas en fechas pasadas.\\n\\nPor favor selecciona una fecha futura (DD/MM/AAAA):`;\n        break;\n      }\n      stateData.date = appointmentDate;\n      stateData.displayDate = `${day}/${month}/${year}`;\n      responseData.needsAPICall = true;\n      responseData.action = 'get_available_times_for_booking';\n      responseData.apiEndpoint = `/api/appointments/available/${appointmentDate}`;\n      responseData.requestedDate = appointmentDate;\n      currentState = 'selecting_time';\n    } else {\n      responseData.responseText = `‚ùå Formato de fecha incorrecto.\\n\\nUsa el formato: DD/MM/AAAA\\nEjemplo: 15/12/2024\\n\\nIntenta nuevamente:`;\n    }\n    break;\n\n case 'selecting_time':\n    // El usuario seleccion√≥ un horario\n    if (stateData.availableTimes && stateData.availableTimes.includes(messageText.trim())) {\n      stateData.time = messageText.trim();\n      // Preparar datos para crear la cita\n      responseData.apiData = {\n        clientName: stateData.clientName || '',\n        phone: stateData.phone || '',\n        socialWork: stateData.socialWork || '',\n        email: typeof stateData.email === 'string' ? stateData.email : '',\n        date: stateData.date || '',\n        time: stateData.time || '',\n        isSobreturno: false\n      };\n      // Validaci√≥n extra: lanzar error si falta alg√∫n campo obligatorio\n      const requiredFields = ['clientName','phone','socialWork','date','time'];\n      let missingField = false;\n      for (const field of requiredFields) {\n        if (!responseData.apiData[field]) {\n          missingField = true;\n        }\n      }\n      if (missingField) {\n        responseData.needsAPICall = false;\n        responseData.action = 'send_message';\n        responseData.responseText = `‚ùå Faltan datos obligatorios para agendar la cita. Por favor revisa los pasos anteriores.`;\n      } else {\n        responseData.needsAPICall = true;\n        responseData.action = 'create_appointment';\n        responseData.apiEndpoint = '/api/appointments';\n        currentState = 'appointment_created';\n      }\n    } else {\n      responseData.responseText = `‚ùå Horario no v√°lido o no disponible.\\n\\nPor favor selecciona uno de los horarios mostrados anteriormente, copiando exactamente el formato (ej: 10:00)`;\n    }\n    break;\n\n  default:\n    responseData.responseText = `ü§î Ha ocurrido un error con el estado de la conversaci√≥n.\\n\\nEscribe *menu* para volver al men√∫ principal.`;\n    currentState = 'waiting_menu_option';\n}\n\n// Guardar el estado actualizado en el objeto de respuesta\nresponseData.currentState = currentState;\nresponseData.stateData = stateData;\n\nreturn { json: responseData };"
      },
      "id": "b418fa12-fdb4-4cb8-90a8-ec27f138197b",
      "name": "Procesador de Mensajes",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        112,
        -624
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "needs_api",
              "leftValue": "={{ $json.needsAPICall }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            }
          ],
          "combineOperation": "any"
        },
        "options": {}
      },
      "id": "8dfda157-260b-4e32-90b9-27a71cb60ca8",
      "name": "¬øNecesita API?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        320,
        -624
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "is_create",
              "leftValue": "={{ $json.action }}",
              "rightValue": "create_appointment",
              "operator": {
                "type": "string",
                "operation": "equals",
                "singleValue": true
              }
            }
          ],
          "combineOperation": "any"
        },
        "options": {}
      },
      "id": "7aa15c59-4606-4306-aca2-5699eb63a45c",
      "name": "¬øCrear Cita?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        512,
        -624
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "backend_url",
              "name": "backendUrl",
              "value": "https://micitamedica.me/",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "84b9d752-935a-453c-bf08-e8bf06b2892b",
      "name": "Configuraci√≥n Backend",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        672,
        -432
      ]
    },
    {
      "parameters": {
        "url": "={{ $('Configuraci√≥n Backend').item.json.backendUrl + $json.apiEndpoint }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "text"
            }
          }
        }
      },
      "id": "f48bbb0b-2d9f-4c26-ba36-b4b79041813b",
      "name": "API Call GET",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        912,
        -720
      ]
    },

    {
      "parameters": {
        "jsCode": "// Intenta parsear la respuesta de la API como JSON.\n// Si falla, devuelve un objeto de error amigable.\n\nlet raw = $input.item.body || $input.item.text || $input.item.json || '';\nlet apiResponse;\n\ntry {\n  if (typeof raw === 'string') {\n    apiResponse = JSON.parse(raw);\n  } else {\n    apiResponse = raw;\n  }\n} catch (e) {\n  apiResponse = {\n    success: false,\n    message: 'La respuesta de la API no es un JSON v√°lido.',\n    raw: raw\n  };\n}\n\nreturn {\n  json: apiResponse\n};"
      },
      "id": "parsear-respuesta-api",
      "name": "Parsear Respuesta API",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1016,
        -720
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Configuraci√≥n Backend').item.json.backendUrl + $json.apiEndpoint }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.apiData) }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "865c51d1-643b-4d4e-b72e-2c1591372ab4",
      "name": "API Call POST",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        912,
        -528
      ]
    },
    {
      "parameters": {
        "jsCode": "// Procesar respuesta de la API y generar mensaje apropiado\nconst inputData = $input.all()[0].json;\nconst apiResponse = $input.all()[1].json;\n\nconsole.log('Procesando respuesta API:', JSON.stringify(apiResponse, null, 2));\nconsole.log('Datos del procesador:', JSON.stringify(inputData, null, 2));\n\nlet responseText = '';\nlet updatedStateData = inputData.stateData || {};\n\n// Procesar seg√∫n el tipo de acci√≥n\nswitch (inputData.action) {\n  case 'get_available_times':\n  case 'get_available_times_for_booking':\n    if (apiResponse.success && apiResponse.data) {\n      const { morning, afternoon } = apiResponse.data.available;\n      \n      // Filtrar solo horarios disponibles\n      const availableMorning = morning.filter(slot => slot.status === 'available');\n      const availableAfternoon = afternoon.filter(slot => slot.status === 'available');\n      \n      if (availableMorning.length === 0 && availableAfternoon.length === 0) {\n        responseText = `‚ùå No hay horarios disponibles para el ${inputData.displayDate || inputData.requestedDate}\\n\\nPor favor selecciona otra fecha o escribe *menu* para volver al men√∫ principal.`;\n      } else {\n        if (inputData.action === 'get_available_times') {\n          // Solo consulta de horarios\n          responseText = `üìÖ *Horarios disponibles para ${inputData.displayDate}*\\n\\n`;\n          \n          if (availableMorning.length > 0) {\n            responseText += `üåÖ **MA√ëANA:**\\n`;\n            availableMorning.forEach(slot => {\n              responseText += `‚Ä¢ ${slot.time}\\n`;\n            });\n            responseText += '\\n';\n          }\n          \n          if (availableAfternoon.length > 0) {\n            responseText += `üåÜ **TARDE:**\\n`;\n            availableAfternoon.forEach(slot => {\n              responseText += `‚Ä¢ ${slot.time}\\n`;\n            });\n            responseText += '\\n';\n          }\n          \n          responseText += `üí° Para agendar una cita escribe *1* o *cita*\\n\\nEscribe *menu* para volver al men√∫ principal.`;\n        } else {\n          // Para agendar cita - mostrar horarios seleccionables\n          responseText = `üìÖ *Horarios disponibles para ${inputData.stateData.displayDate}*\\n\\n`;\n          responseText += `‚úÖ **Selecciona un horario** escribiendo la hora exacta:\\n\\n`;\n          \n          const allAvailable = [];\n          \n          if (availableMorning.length > 0) {\n            responseText += `üåÖ **MA√ëANA:**\\n`;\n            availableMorning.forEach(slot => {\n              responseText += `‚Ä¢ ${slot.time}\\n`;\n              allAvailable.push(slot.time);\n            });\n            responseText += '\\n';\n          }\n          \n          if (availableAfternoon.length > 0) {\n            responseText += `üåÜ **TARDE:**\\n`;\n            availableAfternoon.forEach(slot => {\n              responseText += `‚Ä¢ ${slot.time}\\n`;\n              allAvailable.push(slot.time);\n            });\n            responseText += '\\n';\n          }\n          \n          responseText += `üìù **Ejemplo:** Escribe *10:00* para seleccionar las 10:00\\n\\n‚¨ÖÔ∏è O escribe *menu* para cancelar y volver al men√∫ principal.`;\n          \n          // Guardar los horarios disponibles en el estado\n          updatedStateData.availableTimes = allAvailable;\n        }\n      }\n    } else {\n      responseText = `‚ùå Error al consultar horarios disponibles.\\n\\nPor favor intenta nuevamente o escribe *menu* para volver al men√∫ principal.`;\n    }\n    break;\n    \n  case 'create_appointment':\n    if (apiResponse.success && apiResponse.data) {\n      const appointment = apiResponse.data;\n      responseText = `üéâ **¬°Cita agendada exitosamente!** ‚úÖ\\n\\n`;\n      responseText += `üìã **Resumen de tu cita:**\\n\\n`;\n      responseText += `üë§ **Paciente:** ${appointment.clientName}\\n`;\n      responseText += `üì± **Tel√©fono:** ${appointment.phone}\\n`;\n      responseText += `üè• **Obra Social:** ${appointment.socialWork}\\n`;\n      if (appointment.email) {\n        responseText += `üìß **Email:** ${appointment.email}\\n`;\n      }\n      responseText += `üìÖ **Fecha:** ${inputData.stateData.displayDate}\\n`;\n      responseText += `üïí **Horario:** ${appointment.time}\\n\\n`;\n      responseText += `üìç **Direcci√≥n:** [Tu direcci√≥n del consultorio]\\n\\n`;\n      responseText += `‚ö†Ô∏è **Importante:**\\n`;\n      responseText += `‚Ä¢ Llega 10 minutos antes\\n`;\n      responseText += `‚Ä¢ Trae DNI y credencial de obra social\\n`;\n      responseText += `‚Ä¢ Para cancelar o reprogramar, contacta al consultorio\\n\\n`;\n      responseText += `ü§ñ Escribe *menu* para realizar otra acci√≥n.`;\n      \n      // Resetear el estado del usuario\n      updatedStateData = {};\n    } else {\n      responseText = `‚ùå Error al agendar la cita: ${apiResponse.message || 'Error desconocido'}\\n\\n`;\n      \n      if (apiResponse.message && apiResponse.message.includes('no est√° disponible')) {\n        responseText += `El horario seleccionado ya fue ocupado por otro paciente.\\n\\nPor favor selecciona otro horario o escribe *menu* para volver al men√∫ principal.`;\n      } else {\n        responseText += `Por favor intenta nuevamente o contacta al consultorio.\\n\\nEscribe *menu* para volver al men√∫ principal.`;\n        updatedStateData = {};\n      }\n    }\n    break;\n    \n  default:\n    responseText = 'Error: Acci√≥n no reconocida';\n}\n\nreturn {\n  json: {\n    userNumber: inputData.userNumber,\n    responseText,\n    action: 'send_message',\n    updatedStateData\n  }\n};"
      },
      "id": "47cbe7f3-898a-4433-af18-feef5c7ced0c",
      "name": "Procesar Respuesta API",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        -624
      ]
    },
    {
      "parameters": {
        "jsCode": "// Actualizar estado del usuario despu√©s de respuesta API\nconst inputData = $input.all()[0].json;\n\n// Actualizar estado si es necesario\nif (inputData.updatedStateData && inputData.userNumber) {\n  const userStates = $workflow.static.userStates || {};\n  \n  if (Object.keys(inputData.updatedStateData).length === 0) {\n    // Resetear estado\n    userStates[inputData.userNumber] = { state: 'waiting_menu_option', data: {} };\n  } else {\n    // Actualizar datos del estado\n    if (userStates[inputData.userNumber]) {\n      userStates[inputData.userNumber].data = { ...userStates[inputData.userNumber].data, ...inputData.updatedStateData };\n    }\n  }\n  \n  $workflow.static.userStates = userStates;\n}\n\nreturn {\n  json: {\n    userNumber: inputData.userNumber,\n    responseText: inputData.responseText\n  }\n};"
      },
      "id": "a8f20738-f3e0-43c3-9007-692a1652048d",
      "name": "Actualizar Estado",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1328,
        -624
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://69.62.89.195:8080/message/sendText/test-9-1",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "C7F8CA2C0390-44DA-8307-8DADE95C74F9"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": $json.userNumber,\n  \"text\": $json.responseText\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "b6e7e6f6-e791-433e-bf1d-5fb4b8d34665",
      "name": "Enviar Respuesta WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1520,
        -624
      ]
    }
  ],
  "connections": {
    "Procesador de Mensajes": {
      "main": [
        [
          {
            "node": "¬øNecesita API?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øNecesita API?": {
      "main": [
        [
          {
            "node": "¬øCrear Cita?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Actualizar Estado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øCrear Cita?": {
      "main": [
        [
          {
            "node": "Configuraci√≥n Backend",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Configuraci√≥n Backend",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Configuraci√≥n Backend": {
      "main": [
        [
            {
              "node": "API Call GET",
              "type": "main",
              "index": 0
            },
            {
              "node": "API Call POST",
              "type": "main",
              "index": 0
            }
        ]
      ]
    },
      "API Call GET": {
        "main": [
          [
            {
              "node": "Parsear Respuesta API",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parsear Respuesta API": {
        "main": [
          [
            {
              "node": "Procesar Respuesta API",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Procesar Respuesta API": {
        "main": [
          [
            {
              "node": "Actualizar Estado",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
    "Actualizar Estado": {
      "main": [
        [
          {
            "node": "Enviar Respuesta WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "4b0e4fb3c0e1adf4b413121f19aa866d99097fee1dc6f83b5adf98daaf88b09f"
  }
}