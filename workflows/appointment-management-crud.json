{
  "name": "Appointment Management - CRUD Operations",
  "nodes": [
    {
      "parameters": {
        "path": "appointment-create",
        "options": {}
      },
      "id": "webhook-create-appointment",
      "name": "Webhook - Crear Cita",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 200],
      "webhookId": "appointment-create"
    },
    {
      "parameters": {
        "path": "appointment-update",
        "options": {}
      },
      "id": "webhook-update-appointment",
      "name": "Webhook - Actualizar Cita", 
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 400],
      "webhookId": "appointment-update"
    },
    {
      "parameters": {
        "path": "appointment-delete",
        "options": {}
      },
      "id": "webhook-delete-appointment",
      "name": "Webhook - Eliminar Cita",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 600],
      "webhookId": "appointment-delete"
    },
    {
      "parameters": {
        "jsCode": "// Validar datos de cita\nconst appointmentData = $json;\n\nconst requiredFields = ['clientName', 'socialWork', 'phone', 'date', 'time'];\nconst missingFields = requiredFields.filter(field => !appointmentData[field]);\n\nif (missingFields.length > 0) {\n  throw new Error(`Faltan campos requeridos: ${missingFields.join(', ')}`);\n}\n\n// Validar formato de fecha\nconst dateRegex = /^\\d{4}-\\d{2}-\\d{2}$/;\nif (!dateRegex.test(appointmentData.date)) {\n  throw new Error('Formato de fecha inv√°lido (YYYY-MM-DD)');\n}\n\n// Validar formato de hora\nconst timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;\nif (!timeRegex.test(appointmentData.time)) {\n  throw new Error('Formato de hora inv√°lido (HH:MM)');\n}\n\n// Validar que la fecha no sea en el pasado\nconst appointmentDate = new Date(`${appointmentData.date}T${appointmentData.time}`);\nconst now = new Date();\nif (appointmentDate < now) {\n  throw new Error('No se pueden crear citas en el pasado');\n}\n\nreturn [{ json: appointmentData }];"
      },
      "id": "validate-appointment-data",
      "name": "Validar datos de cita",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 200]
    },
    {
      "parameters": {
        "url": "={{$env.CITAMEDICA_API_URL}}/appointments",
        "sendBody": true,
        "specifyHeaders": true,
        "headers": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendQuery": false,
        "sendHeaders": true,
        "contentType": "json",
        "body": "={{JSON.stringify($json)}}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "create-appointment-api",
      "name": "Crear cita en API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [680, 200]
    },
    {
      "parameters": {
        "url": "={{$env.CITAMEDICA_API_URL}}/appointments/{{$json.appointmentId}}",
        "sendBody": true,
        "specifyHeaders": true,
        "headers": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "requestMethod": "PUT",
        "contentType": "json",
        "body": "={{JSON.stringify($json.updateData)}}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "update-appointment-api",
      "name": "Actualizar cita en API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [680, 400]
    },
    {
      "parameters": {
        "url": "={{$env.CITAMEDICA_API_URL}}/appointments/{{$json.appointmentId}}",
        "requestMethod": "DELETE",
        "options": {
          "timeout": 30000
        }
      },
      "id": "delete-appointment-api",
      "name": "Eliminar cita en API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [680, 600]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.success}}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-appointment-created",
      "name": "¬øCita creada exitosamente?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [900, 200]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.success}}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-appointment-updated",
      "name": "¬øCita actualizada exitosamente?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [900, 400]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.success}}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-appointment-deleted",
      "name": "¬øCita eliminada exitosamente?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [900, 600]
    },
    {
      "parameters": {
        "jsCode": "// Crear mensaje de confirmaci√≥n de cita creada\nconst appointmentData = $json;\n\nconst confirmationMessage = `‚úÖ *CITA CONFIRMADA*\\n\\n` +\n  `Tu cita m√©dica ha sido agendada exitosamente:\\n\\n` +\n  `üë§ **Paciente:** ${appointmentData.clientName}\\n` +\n  `üè• **Obra Social:** ${appointmentData.socialWork}\\n` +\n  `üìÖ **Fecha:** ${new Date(appointmentData.date).toLocaleDateString('es-AR')}\\n` +\n  `‚è∞ **Horario:** ${appointmentData.time}\\n` +\n  `üÜî **ID Cita:** ${appointmentData._id}\\n\\n` +\n  `*Recordatorio:* Llega 10 minutos antes de tu cita.\\n\\n` +\n  `¬°Te esperamos! üè•`;\n\nreturn [{\n  json: {\n    phone: appointmentData.phone,\n    message: confirmationMessage,\n    appointmentId: appointmentData._id,\n    type: 'appointment_created'\n  }\n}];"
      },
      "id": "create-confirmation-message",
      "name": "Crear mensaje de confirmaci√≥n",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 100]
    },
    {
      "parameters": {
        "jsCode": "// Crear mensaje de actualizaci√≥n\nconst appointmentData = $json;\n\nconst updateMessage = `üìù *CITA ACTUALIZADA*\\n\\n` +\n  `Tu cita m√©dica ha sido modificada:\\n\\n` +\n  `üë§ **Paciente:** ${appointmentData.clientName}\\n` +\n  `üè• **Obra Social:** ${appointmentData.socialWork}\\n` +\n  `üìÖ **Nueva Fecha:** ${new Date(appointmentData.date).toLocaleDateString('es-AR')}\\n` +\n  `‚è∞ **Nuevo Horario:** ${appointmentData.time}\\n` +\n  `üÜî **ID Cita:** ${appointmentData._id}\\n\\n` +\n  `*Recordatorio:* Llega 10 minutos antes de tu cita.\\n\\n` +\n  `¬°Te esperamos! üè•`;\n\nreturn [{\n  json: {\n    phone: appointmentData.phone,\n    message: updateMessage,\n    appointmentId: appointmentData._id,\n    type: 'appointment_updated'\n  }\n}];"
      },
      "id": "create-update-message",
      "name": "Crear mensaje de actualizaci√≥n",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "jsCode": "// Crear mensaje de cancelaci√≥n\nconst deleteData = $('Webhook - Eliminar Cita').first().json;\n\nconst cancellationMessage = `‚ùå *CITA CANCELADA*\\n\\n` +\n  `Tu cita m√©dica ha sido cancelada exitosamente.\\n\\n` +\n  `Si necesitas reagendar, por favor contacta nuevamente.\\n\\n` +\n  `¬°Gracias por avisarnos! üè•`;\n\nreturn [{\n  json: {\n    phone: deleteData.phone,\n    message: cancellationMessage,\n    appointmentId: deleteData.appointmentId,\n    type: 'appointment_cancelled'\n  }\n}];"
      },
      "id": "create-cancellation-message",
      "name": "Crear mensaje de cancelaci√≥n",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 500]
    },
    {
      "parameters": {
        "url": "={{$env.EVOLUTION_API_URL}}/message/sendText/{{$env.EVOLUTION_INSTANCE_NAME}}",
        "sendBody": true,
        "specifyHeaders": true,
        "headers": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{$env.EVOLUTION_API_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "contentType": "json",
        "body": "={\n  \"number\": \"{{$json.phone}}\",\n  \"text\": \"{{$json.message}}\"\n}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "send-notification-whatsapp",
      "name": "Enviar notificaci√≥n WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "jsCode": "// Programar recordatorio de cita\nconst appointmentData = $json;\n\nif (appointmentData.type === 'appointment_created') {\n  const appointmentDateTime = new Date(`${appointmentData.date}T${appointmentData.time}`);\n  const reminderTime = new Date(appointmentDateTime.getTime() - (2 * 60 * 60 * 1000)); // 2 horas antes\n  \n  return [{\n    json: {\n      appointmentId: appointmentData._id,\n      patientPhone: appointmentData.phone,\n      patientName: appointmentData.clientName,\n      appointmentDate: appointmentData.date,\n      appointmentTime: appointmentData.time,\n      reminderTime: reminderTime.toISOString(),\n      type: 'schedule_reminder'\n    }\n  }];\n}\n\nreturn [];"
      },
      "id": "schedule-reminder",
      "name": "Programar recordatorio",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 700]
    },
    {
      "parameters": {
        "url": "http://localhost:3000/webhook/reminder-trigger",
        "sendBody": true,
        "contentType": "json",
        "body": "={{JSON.stringify($json)}}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "trigger-reminder-workflow",
      "name": "Activar workflow de recordatorio",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1340, 700]
    },
    {
      "parameters": {
        "jsCode": "// Manejar errores y enviar notificaci√≥n\nconst error = $json;\nconst webhookData = $('Webhook - Crear Cita').first().json;\n\nconst errorMessage = `‚ùå *ERROR AL PROCESAR CITA*\\n\\n` +\n  `Lo siento, ocurri√≥ un error al procesar tu solicitud:\\n\\n` +\n  `**Error:** ${error.message || 'Error desconocido'}\\n\\n` +\n  `Por favor, intenta de nuevo o contacta directamente con la cl√≠nica.\\n\\n` +\n  `üè• *Cl√≠nica M√©dica*`;\n\nreturn [{\n  json: {\n    phone: webhookData.phone,\n    message: errorMessage,\n    type: 'error_notification'\n  }\n}];"
      },
      "id": "handle-error",
      "name": "Manejar error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 900]
    }
  ],
  "connections": {
    "Webhook - Crear Cita": {
      "main": [
        [
          {
            "node": "Validar datos de cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook - Actualizar Cita": {
      "main": [
        [
          {
            "node": "Actualizar cita en API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook - Eliminar Cita": {
      "main": [
        [
          {
            "node": "Eliminar cita en API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar datos de cita": {
      "main": [
        [
          {
            "node": "Crear cita en API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear cita en API": {
      "main": [
        [
          {
            "node": "¬øCita creada exitosamente?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar cita en API": {
      "main": [
        [
          {
            "node": "¬øCita actualizada exitosamente?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Eliminar cita en API": {
      "main": [
        [
          {
            "node": "¬øCita eliminada exitosamente?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øCita creada exitosamente?": {
      "main": [
        [
          {
            "node": "Crear mensaje de confirmaci√≥n",
            "type": "main",
            "index": 0
          },
          {
            "node": "Programar recordatorio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Manejar error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øCita actualizada exitosamente?": {
      "main": [
        [
          {
            "node": "Crear mensaje de actualizaci√≥n",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Manejar error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øCita eliminada exitosamente?": {
      "main": [
        [
          {
            "node": "Crear mensaje de cancelaci√≥n",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Manejar error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear mensaje de confirmaci√≥n": {
      "main": [
        [
          {
            "node": "Enviar notificaci√≥n WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear mensaje de actualizaci√≥n": {
      "main": [
        [
          {
            "node": "Enviar notificaci√≥n WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear mensaje de cancelaci√≥n": {
      "main": [
        [
          {
            "node": "Enviar notificaci√≥n WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Programar recordatorio": {
      "main": [
        [
          {
            "node": "Activar workflow de recordatorio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manejar error": {
      "main": [
        [
          {
            "node": "Enviar notificaci√≥n WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "timezone": "America/Argentina/Buenos_Aires",
    "saveExecutionProgress": true,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all"
  },
  "staticData": {},
  "tags": [
    {
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "id": "appointments",
      "name": "Appointments"
    },
    {
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "id": "crud",
      "name": "CRUD"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2024-01-01T00:00:00.000Z",
  "versionId": "1"
}